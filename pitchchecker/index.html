<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Volume Display</title>
</head>
<body>
    <p>音量：<progress id="volume" min="0" max="100" value="0"></progress></p>
    <p>周波数：<span id="frequency">0</span> Hz</p>
    <p>ピッチ：<span id="pitch">A4</span></p>
    <script>
    class PitchChecker {
        constructor() {
            // no constructor properties needed at this time
        }

        frequencyToNoteNumber(frequency) {
            return 12 * (Math.log(frequency / 440) / Math.log(2)) + 69;
        }

        noteNumberToName(noteNumber) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const octave = Math.floor(noteNumber / 12);
            const noteName = noteNames[noteNumber % 12];
            return noteName + octave;
        }

        frequencyToNoteName(frequency) {
            const noteNumber = this.frequencyToNoteNumber(frequency);
            return this.noteNumberToName(Math.round(noteNumber));
        }

        calculateVolume(dataArray, bufferLength) {
            let sum = 0;
            let maxIndex = 0;
            for(let i = 0; i < bufferLength; i++) {
                sum += dataArray[i] * dataArray[i];
                if(dataArray[i] > dataArray[maxIndex]) {
                    maxIndex = i;
                }
            }

            const rms = Math.sqrt(sum / bufferLength);
            return { volume: Math.min((rms / 255) * 200, 100), maxIndex: maxIndex };  // 2倍の感度、ただし上限は100
        }
    }

    window.onload = function() {
        const pitchChecker = new PitchChecker();

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const source = context.createMediaStreamSource(stream);
                const analyser = context.createAnalyser();
                analyser.fftSize = 1024;

                source.connect(analyser);

                const volumeDisplay = document.getElementById('volume');
                const frequencyDisplay = document.getElementById('frequency');
                const pitchDisplay = document.getElementById('pitch');
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const update = () => {
                    analyser.getByteFrequencyData(dataArray);
                    const { volume, maxIndex } = pitchChecker.calculateVolume(dataArray, bufferLength);
                    volumeDisplay.value = volume;

                    const dominantFrequency = maxIndex * context.sampleRate / analyser.fftSize;
                    frequencyDisplay.textContent = dominantFrequency.toFixed(2);

                    const pitch = pitchChecker.frequencyToNoteName(dominantFrequency);
                    pitchDisplay.textContent = pitch;

                    requestAnimationFrame(update);
                };
                update();
            })
            .catch(err => {
                console.error('マイクへのアクセスが許可されていません。ブラウザの設定を確認して、マイクへのアクセスを許可してください。エラー詳細:', err);
            });
    };
    </script>
</body>
</html>
