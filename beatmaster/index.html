<!DOCTYPE html>
<html>
<head>
  <title>クリック音アプリ</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div id="app" class="app"></div>

  <script>
    // サウンド再生を担当するクラス
    class SoundPlayer {
      constructor(src) {
        this.audio = new Audio(src);
        this.audio.preload = 'auto';
      }

      // サウンドを再生する
      play() {
        this.audio.currentTime = 0;
        this.audio.play();
      }
    }

    // タイマーを管理するクラス
    class Timer {
      constructor(bpm, soundPlayer) {
        this.bpm = bpm;
        this.soundPlayer = soundPlayer;
        this.interval = null;
        this.isPlaying = false;
      }

      // 1拍あたりの間隔を計算する
      calculateInterval() {
        var millisecondsPerBeat = (60 / this.bpm) * 1000;
        return millisecondsPerBeat;
      }

      // タイマーを開始する
      start() {
        if (this.isPlaying) {
          return;
        }
        var intervalDuration = this.calculateInterval();
        this.interval = setInterval(() => {
          this.soundPlayer.play();
        }, intervalDuration);

        this.isPlaying = true;
      }

      // タイマーを停止する
      stop() {
        clearInterval(this.interval);
        this.interval = null;
        this.isPlaying = false;
      }

      // BPMを更新してタイマーを再設定する
      updateBPM(newBPM) {
        this.bpm = newBPM;
        if (this.interval) {
          clearInterval(this.interval);
          this.isPlaying = false;
          this.start();
        } else {
          this.start();
        }
      }
    }

    // クリック音アプリを管理するクラス
    class ClickSoundApp {
      constructor() {
        this.bpm = 120;
        this.clickSound = new SoundPlayer('click_sound.mp3');
        this.backSound = new SoundPlayer('back_sound.mp3');
        this.timer = new Timer(this.bpm, this.clickSound);
      }

      // UIを生成する
      createUI() {
        var appDiv = document.getElementById('app');

        // BPM表示の要素
        var bpmDisplay = document.createElement('span');
        bpmDisplay.id = 'bpmDisplay';
        bpmDisplay.textContent = this.bpm;
        var bpmLabel = document.createElement('p');
        bpmLabel.textContent = 'BPM: ';
        bpmLabel.appendChild(bpmDisplay);

        // BPMスライダーの要素
        var bpmSlider = document.createElement('input');
        bpmSlider.type = 'range';
        bpmSlider.id = 'bpmSlider';
        bpmSlider.min = '60';
        bpmSlider.max = '240';
        bpmSlider.value = this.bpm;
        bpmSlider.addEventListener('input', () => this.updateBPM());

        // Startボタンの要素
        var startButton = document.createElement('button');
        startButton.textContent = 'Start';
        startButton.addEventListener('click', () => this.startTimer());

        // Stopボタンの要素
        var stopButton = document.createElement('button');
        stopButton.textContent = 'Stop';
        stopButton.addEventListener('click', () => this.stopTimer());

        // 裏ボタンの要素
        var backButton = document.createElement('button');
        backButton.id = 'backButton';
        backButton.textContent = '裏';
        backButton.addEventListener('mousedown', () => this.playBackSound());

        // 生成した要素をappDivに追加する
        appDiv.appendChild(bpmLabel);
        appDiv.appendChild(bpmSlider);
        appDiv.appendChild(startButton);
        appDiv.appendChild(stopButton);
        appDiv.appendChild(backButton);
      }

      // BPMを更新する
      updateBPM() {
        var slider = document.getElementById('bpmSlider');
        var display = document.getElementById('bpmDisplay');
        this.bpm = parseInt(slider.value);
        display.textContent = this.bpm;
        this.timer.updateBPM(this.bpm);
      }

      // タイマーを開始する
      startTimer() {
        this.timer.start();
      }

      // タイマーを停止する
      stopTimer() {
        this.timer.stop();
      }

      // 裏拍の音を再生する
      playBackSound() {
        this.backSound.play();
      }

      // キーボードのキー押下イベントを処理する関数
      handleKeyDown(event) {
        if (event.keyCode === 32) {
          this.playBackSound();
        }
      }

      // アプリケーションを初期化する
      initialize() {
        this.createUI();
        document.addEventListener('keydown', (event) => this.handleKeyDown(event));
      }
    }

    // ClickSoundAppクラスのインスタンスを作成し、初期化する
    var app = new ClickSoundApp();
    app.initialize();
  </script>
</body>
</html>
